# Spotify

# 1. Тема и целевая аудитория
Spotify - музыкальный стриминговый сервис, позволяющий прослушивать музыкальные композиции, аудиокниги и подкасты.

## MVP 
- регистрация/авторизация;
- добавление понравившейся музыки (поставить лайк песне);
- поиск музыки;
- создание плейлистов;
- возможность лейблам добавлять музыку;
- оформление подписки;
- система рекомендации треков.

## Целевая аудитория
MAU составляет 696M[^1].

- Только 276M пользователей Spotify имеют премиум подписку.
- 44% пользователей - мужчины, 56% - женщины.
- 26% пользователей в диапазон от 18 - 24 лет, 29% в диапазоне 25 - 34, 16% в диапазоне от 35 - 44, 11% в диапазоне от 45 - 54, 19% старше 55 лет[^2].

### Распределение активных пользователей Spotify по регионам[^1]
| Регион | Кол-во пользователей, млн |
|--|--|
| Европа | 194.8 |
| Южная Америка| 190.2|
| Северная Америка | 132.2 |
| Остальной мир | 222.72 |

Категория “Остальной мир” очень динамична благодаря быстрому расширению Spotify на развивающихся рынках, таких как Индия и другие части Азии и Африки.

# 2. Расчет нагрузки

## Продуктовые метрики
- Месячная аудитория 696 млн;
- Дневная аудитория: отношение DAU/MAU = 0.2 => DAU = 0.2 * 696 ≈ 139,2 млн [^3];

### Среднее кол-во действий пользователя по типам в день
| Функционал | Среднее кол-во действий, раз |
|-|-|
| регистрация/авторизация| (MAU2025 - MAU2024) / 365 = (696 млн - 626 млн) / 365 = 192 тыс |
| добавление понравившейся музыки (поставить лайк песне) | DAU * (2 + 0) / 2 = 139 млн |
| поиск музыки | 4 * DAU = 556 млн |
| создание плейлистов | 1,2 млн [^7]|
| возможность лейблам добавлять музыку | 60000 [^1] |
| оформление подписки | 72222 [^5]|

## Технические метрики
### Хранилище
- Регистрация
Здесь основную часть будут занимать аватарки пользователей, средний вес которой равен 2 Мб. За всё время (2006 - 2025): 696 млн пользователей * 2 Мб = 1392 Тб = 1,4 Пб.
За год: 1392 Тб / 19 лет = 73 Тб.
За квартал: 18,25 Тб.

- Возможность лейблам добавлять музыку: всего 100 млн треков, средний размер трека 3 - 10 Мб в зависимости от качества трека => средний размер трека равен 6,5 Мб => размер всей библиотеки песен = 635000 Гб + размер исходника (50 Мб) * 100 млн (т.к. спотифаю необходимо хранить исходники треков) = 635 Тб + 5000 Тб = 5635 Тб.
  

Незначительные по объему:
- Проставление лайка треку: добавляется запись в таблицу, которая хранит id пользователя и id трека => 8 байт + 8 байт = 16 байт.
- Создание плейлистов: необходимо хранить название плейлиста (50 символов), id плейлиста, id пользователя, id треков, которые он хранит, предположим, что средний размер плейлиста равен 30 треков => 50 байт * 2 + 8 байт + 8 байт + 8 байт * 30 = 356 байт.
- Оформление подписки: данные о пользователе и зашифрованные данные о способе оплаты = 30 байт (username) + 120 байт (данные о способе оплаты) = 150 байт.
  
| Действие | Объем памяти за все время | Объем памяти за год | Объем памяти за квартал |
|-|-|-|-|
| Регистрация | 1,4 Пб | 73 Тб | 18 Тб |
| Проставление лайка треку | 15,4 Тб | 812 Гб | 203 Гб |
| Возможность лейблам добавлять музыку | 5635 Тб | 296 Тб | 74 Тб |
| Создание плейлистов | 343 Тб |  18,06 Тб | 4,5 Тб |

### Сетевой трафик
Сводная таблица RPS по типовым действиям, средний и пиковый трафики

| Действие                               | Тип   | RPD           | RPS    | Средний трафик | Пиковый трафик |
|----------------------------------------|-------|---------------|--------|----------------|----------------|
| Регистрация/авторизация        | Запись/чтение  | 192 000       | 2,22   | 35,2 Мбит/с      | 70,4 Мбит/с           |
| Добавление лайка песни                  | Чтение| 139 200 000   | 1 611  | 10 Мбит/с        | 20 Мбит/с       |
| Поиск музыки                            | Запись| 556 800 000   | 6 444  | 45 Гбайт/с      | 90 Гбайт/с      |
| Создание плейлистов                     | Запись| 1 200 000     | 14     | 0,12 Мбит/с      | 0,24 Мбит/с     |
| Возможность лейблам добавлять музыку    | Запись| 60 000        | 0,7    | 700 Мб/с         | 1400 Мб/с        |
| Оформление подписки                     | Запись| 72 222        | 0,836  | 0,006 Мбит/с     | 0,012 Мбит/с     |

Пояснение для таблицы:
- RPD взято из пункта выше Среднее количество действий пользователей по типам в день
- RPS = RPD / 86400. Здесь 86400 = 24 часа * 60 минут * 60 секунд
- Средний трафик = RPS * <Вес данных из пункта выше Хранилище> + <Средний размер заголовка запроса (750 байт)>
- Пиковый трафик = <Средний трафик> * <Коэффициент отношения пикового трафика к среднему = 2


# 3. Глобальная балансировка нагрузки

## Обоснование расположения ДЦ
Известно, что основными пользователями Spotify являются жители Европы. 
Поэтому в Европе датацентры будут находиться во Франкфурте-на-Майне в Германии, в Амстердаме в Нидерландах, в Мадриде в Испании, а также в Стокгольме в Швеции.
В США датацентры будут в Сан-Франциско и Нью-Йорке.
В Южной Америке в Сан-Паулу в Бразилии.
В Африке в ЮАР.
А также в Мумбаи в Индии и в Сингапуре, так как там сейчас наиболее быстро развивается рынок.
| Регион | Страна | Город |
|--------|--------|-------|
|Европа| Германия| Франкфурт-на-Майне|
|Европа| Нидерланды | Амстердам |
|Европа| Испания | Мадрид |
|Европа| Швеция | Стокгольм|
|Северная Америка| США| Сан-Франциско |
|Северная Америка| США| Нью-Йорк |
|Южная Америка| Бразилия | Сан-Паулу |
|Африка| Южная Африка| Йоханнесбург |
|Азия| Индия | Мумбаи |
|Азия| Сингапур| Сингапур |

## Глобальная балансировка
Балансировка нагрузки будет осуществляться следующим образом:
GeoDNS: для определения местоположения клиента на основе его географических данных, что позволяет направить его к наиболее близкому серверному центру в соответствующем регионе.

# 4. Локальная балансировка нагрузки

## L4
В качестве L4 балансировщика будет использоваться Virtual Server via Direct Routing. Этот метод обладает максимальной производительностью, так как ответ от бэкенд-сервера уходит напрямую клиенту, минуя балансировщик. Недостаток данного метода в том, что все серверы должны находитсья в одной физической сети. Это можно обойти с помощью GRE-туннелей.

На каждый датацентр резервируется N+1 балансировщик.


## L7
Запросы будут обрабатываться по алгоритму Least Connections.

Каждый запрос проходит два уровня балансировки.
![image](/img/ssl.svg)

Так как для некоторых запросов высокий RPS, то потребуется кластер серверов для дешифрования данных.

На каждый датацентр резервируется N+1 балансировщик.

## Отказоустойчивость 
Автоматическое переключение на резервные узлы выполняется с помощью keepalived.

## Расчет необходимого числа балансировщиков
L3/L4: 1 устройство = 100 Гбит/с
L7: 1 устройство = 5 000 RPS / 20 Гбит/с (SSL дешифровка)
| Расположение ДЦ        | Регион           | Гбит/с | N (L4) | N (L7) |
| ---------------------- | ---------------- | -----: | -----: | -----: |
| Франкфурт-на-Майне | Европа           |     85 |      2 |      2 |
| Амстердам          | Европа           |     43 |      2 |      2 |
| Мадрид             | Европа           |     43 |      2 |      2 |
| Стокгольм          | Европа           |     43 |      2 |      2 |
| Сан-Франциско      | Северная Америка |    110 |      3 |      2 |
| Нью-Йорк           | Северная Америка |    109 |      3 |      2 |
| Сан-Паулу          | Южная Америка    |     73 |      2 |      2 |
| Йоханнесбург       | Африка           |     22 |      2 |      2 |
| Мумбаи             | Азия             |     73 |      2 |      2 |
| Сингапур           | Азия             |     73 |      2 |      2 |


# 5. Логическая схема БД
![db6](/img/db_6.svg)

## Размеры полей (в байтах)

|user| artist| album | genre | album_genre_ref| album_artist_ref| artist_genre_ref | track | track_album_ref| track_artist_ref | track_genre_ref | playlist | track_playlist_ref | like_album | like_artist| like_track| like_playlist| document | subscription|
|----|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-| -| -|
|id 16            | id 16           | id 16           | id 16    | id 16       | id 16       | id 16       | id 16          | id 16       | id 16        | id 16        | id 16        | id 16          | id 16        | id 16       | id 16       | id 16         |     id 16 | id 16
| email 500       | title 500        | title 500        | genre 32 | album_id 16 | album_id 16 | artist_id 16| thumbnail_id 16| track_id 16 | track_id 16  | track_id 16  | title 500           | track_id 16    | user_id 16   | user_id 16  | user_id 16  | user_id 16    | content_type 1 | user_id 16 |
| username 500     | thumbnail_id 16 | thumbnail_id 16 |          | genre_id 16 | artist_id 16| genre_id 16 | song_id 16     | album_id 16 | artist_id 16 | genre_id 16  | thumbnail_id 16    | playlist_id 16 | album_id 16  | artist_id 16| track_id 16 | playlist_id 16| checksum 32 | subscription_type 1|
|thumbnail_id 16  | description 500 | realease_date 4 |          | created_at 8| created_at 8| created_at 8| duration 4     | created_at 8| created_at 8 | created_at 8 | user_id 16           | created_at 8   | created_at 8 | created_at 8| created_at 8| created_at 8  | storage_path 8192 | started_at 8|
| password_hash 60| created_at 8    |                 |          |             |             |             | created_at 8   | | |                            | created_at 8   |                |              |             |             |               |   size 8 | ended_at 8 |
| created_at 8    | updated_at 8    |                 |          |             |             |             | updated_at 8   | | |                            | updated_at 8   |                |              |             |             |               |     metadata 500 |
|updated_at 8     |                 |                 |          |             |             |             | title 500 | | | | | | | | | |  created_at 8 |

## Рассчеты для таблиц
| Таблица | Вес записи | Кол-во добавлений в бд / сутки | Прирост / сутки|
|-|-|-|-|
| user | 1108 байт   | 192000 | 202 Мб |
| artist | 1048 байт | 0.5 |  524 байт |
| album | 536 байт   | 3000 | 1.5 Мб |
| genre | 48 байт   | 0.022 | 1.056 байт |
| album_genre_ref | 56 байт | 3000 | 0.16 Мб |
| album_artist_ref | 56 байт |3500 | 0.19 Мб |
| artist_genre_ref | 56 байт | 0.5 | 28 байт |
| track | 568 байта | 60000 | 32.5 Мб |
| track_album_ref | 56 байт | 60000 | 3.2 Мб |
| track_artist_ref | 56 байт | 70000 | 3.7 Мб |
| track_genre_ref | 56 байт | 60000 | 3.2 Мб |
| playlist | 564 байт | 1 200 000 |  645 Мб |
| track_playlist_ref | 56 байт | 36 000 000 | 1.922 Гб |
| like_track | 56 байт | 139 000 000 | 7 Гб |
| document | 8757 байт | 1 515 000 | 12.3 Гб |
| subscription | 49 байт | 72222 | 3.4 Мб|

## QPS
| Таблица | Чтение | Запись | Комментарий |
|-|-|-| - |
| user | 1 | 2 | - |
| artist | 1500 (15) | - | Большинство запросов пойдут в кэш |
| album | 1500 (15) | - | Большинство запросов пойдут в кэш |
| genre | 1500 | - | - |
| album_genre_ref | 2000 | - | - |
| album_artist_ref | 1500 | - | - |
| artist_genre_ref | 1500 | - | - |
| track | 3000 | 0.7 | Большинство запросов пойдут в кэш |
| track_album_ref | 1500 | - | - |
| track_artist_ref | 1500 | - | - |
| track_genre_ref | 1000 | - | - |
| playlist | 700 | 1000 | - |
| track_playlist_ref | 800 | - | - |
| like_track | 1500 | 1500 | - | - |
| document | 4000 | 2 | - | - |
| subscription | 1 | 1 | - | - |

Наибольшая нагрузка идет на базу данных при поиске треков, артистов, альбомов или плейлистов.

## Требования к консистентности 
| Таблица | Уровень консистентности | Комментарий | 
| - | - | - |
| user | Strong | Важно, чтобы данные были актуальны во всех репликах, если пользователь сразу начнёт лайкать треки |  
| artist | Eventual | Если артист только создал свой аккаунт, то небольшая задержка допустима перед тем как он начнет отображаться в поиске у всех пользователей | 
| album | Strong | Важно, чтобы новый альбом исполнителя отображался у всех слушателей сразу | 
| genre | Eventual | Лейблы не ощущат проблем, если новый жанр не сразу добавится |
| album_genre_ref | Strong | Важно, чтобы сразу был связан альбом и его жанр | 
| album_artist_ref | Strong | Важно, чтобы сразу был связан альбом и его исполнители | 
| track | Sequential | Если добавлен альбом, то должны быть и добавлены его треки| 
| track_album_ref | Strong | Важно, чтобы треки сразу подгружались к альбому| 
| track_artist_ref | Strong | Важно, чтобы треки сразу связывались с артистами| 
| track_genre_ref | Strong | Важно, чтобы треки сразу связывались с жанрами| 
| playlist | Eventual| Допустима небольшая задержка при отображении плейлиста после его создания | 
| track_playlist_ref | Strong | Важно, чтобы треки сразу синхронизировались с плейлистами| 
| like_track | Strong | Важно, чтобы лайк сразу отображался у трека, и трек сохранялся в плейлисте пользователя | 
| document | Strong | Недопустимо, если отображается трек, но нет самого аудиофайла |
| subscription | Eventual | Допустима небольшая задержка перед тем, как пользователь увидит, что подписка была создана |


# 6. Физическая схема БД
![db7](/img/db_7.svg)

## Выбор бд по таблицам
| Таблица | База данных |
|-|-|
|user| Postgres | 
|artist| Postgres |
|album| Postgres |
|album_artist_ref| Postgres| 
|track_album_ref| Postgres |
|track| Postgres |
|track_artist_ref| Postgres|
|playlist| Postgres |
|track_playlist_ref| Postgres |
|user_like| Postgres |
|artist_cache| Redis |
|track_cache| Redis |
|album_cache| Redis |
|document| Postgres, Amazon S3 |
| subscription| Postgres |
| user_playlist_like |Postgres |
|session |Redis|
|search_index| ElasticSearch |

## Индексы
| Таблица | Индексы |
|-|-|
|user| - | 
|artist| pk(id); title |
|album| pk(id); title |
|album_artist_ref| btree(album_id); btree(artist_id)| 
|track_album_ref| btree(track_id); btree(album_id)|
|track| pk(id); btree(album_id); gin(genres); gin(artist_titles); gin(artist_ids)|
|track_artist_ref| btree(track_id); btree(artist_id)|
|playlist| pk(id); btree(title) |
|track_playlist_ref| btree(track_id); btree(playlist_id)|
|user_like| btree(user_id); btree(track_id); btree(album_id); btree(track_title); gin(artist_titles); gin(artist_ids) |
|document| pk(id) |
| subscription| - |
| user_playlist_like | pk(id); btree(user_id); btree(playlist_id); btree(playlist_title); btree(author_title) |
| search_index | по всем полям |

## Шардирование и репликация
| Таблциа | Шардирование | Репликация |
|-|-|-|
| user | user_id hash | 1 основной сервер и 2 реплики|
|artist| title по диапазону | 1 основной сервер и 2 реплики|
|album| title по диапазону |1 основной сервер и 2 реплики|
|album_artist_ref| - | 1 основной сервер и 2 реплики|
|track_album_ref|-|1 основной сервер и 2 реплики|
|track_artist_ref|-|1 основной сервер и 2 реплики|
|track| title по диапазону | 1 основной сервер и 3 реплики|
| playlist| title по диапазону | 1 основной сервер и 2 реплики |
|user_like| user_id hash | 1 основной сервер и 3 реплики |
|document| геолокация | cross-region replication |
|subscription| user_id hash| 1 основной сервер и 1 реплика|
|user_playlist_like| user_id hash | 1 основной сервер и 2 реплики |
|artist_cache| - | кластер Redis с двумя репликами| 
|track_cache| - | кластер Redis с двумя репликами|
|album_cache| -| кластер Redis с двумя репликами|
|session | -| кластер Redis с двумя репликами|

## Клиентские библиотеки
- PostgreSQL: Golang - pgx, Rust - tokio-postgres
- Redis: Golang - go-redis, Rust - redis
- Amazon S3: Golang - aws-sdk-go-v2, Rust - zerofs

## Балансировка запросов
- PostgreSQL: PgBouncer 
- Redis: Redis-cluster

## Схема резервного копирования
- PostgreSQL: ежедневные снапшоты + wal архивирование
- Redis: RDB снапшоты.
- Amazon S3: внутренние методы amazon.

# 7. Алгоритмы
| Алгоритм | Область применения | Описание |
| - | - | - |
| Совместная фильтрация | Система рекомендаций | Алгоритм анализирует, какие треки слушают люди с похожими вкусами, и предлагает тебе те песни, которые они также предпочитают. Система выявляет общие паттерны предпочтений без необходимости анализировать содержимое самих треков|
| Фильтрация на основе содержимого | Система рекомендаций | Подбирает треки, похожие на те, что пользователю уже нравятся, исходя из их характеристик. Алгоритм анализирует особенности песен с помощью ИИ — темп, жанр, настроение, вокал, инструментальную структуру и т.п. |
| NLP | Система рекомендаций | Spotify применяет обработку естественного языка для анализа описаний плейлистов, статей и рецензий, постов в соцсетях, текстов песен |
| Discovery mode | Система рекомендаций | Когда артист включает трек в Discovery Mode, сервис даёт ему повышенный приоритет в рекомендациях |
| Dynamic adaptive streaming | Стриминг треков | Spotify анализирует сетевое соединение и динамически изменяет качество потока без прерывания музыки |
| Ogg Vorbis | Сжатие треков | Используется на Android, Desktop |
| AAC | Сжатие треков | Используется на IOS, Web-плеере |

## Пример первой генерации рекомендаций
![db7](/img/reg_reg.svg)

В самом начале система рекомендаций опирается на возраст пользователя, страну, язык устройства, а также на любимых артистов и жанры.

# 8. Технологии
| Технология | Область применения | Описание |
| - | - | - |
| Redis | Кэширование, хранение сессий | Высокая скорость чтения, TTL |
| PostgreSQL | Хранение данных | Strong consistency, надёжная репликация и шардинг, сложные SQL запросы |
| S3 | Хранение треков и изображений | Надёжное хранение больших данных, гео-репликация |
| Golang | Логика на сервере | Многопоточность, обширная поддержка комьюнити |
| Python | Система рекомендаций | Обширная экосистема для работы с ML |
| Pinecone | Система рекомендаций | Векторная база данных с высокой скоростью поиска |
| TypeScript | Клиентская часть | Стандарт для клиентской части | 
| gRPC | Общение между микросервисами | Высокопроизводительный фреймворк удалённых процедур |
| ElasticSearch | Поиск треков | Поисковая система данных |
| Nginx | Прокси | Высокая производительность, распределение нагрузки |
| Kafka | Очередь | Платформа потоковой передачи данных |
| Docker | Контейнеризация | Позволяет упаковывать код вместе со всеми зависимостями и запускать его изолированно от окружения |
| Kubernetes | Оркестрация контейнеров | Управляет контейнерами, сам их переподнимает, распределяет нагрузку |
| Vault | Хранилище секретов | Позволяет удаленно хранить секреты для разработчиков |
| Prometheus | База данных временных рядов | Используется для сбора метрик |
| Grafana | Визуализация | Используется для визуализации метрик |




## Источники
[^1]: Статистика пользователей Spotify - https://www.demandsage.com/spotify-stats/
[^2]: Статистика пользователей Spotify по возрасту - https://techbehemoths.com/blog/spotify-marketing-strategy-analyzed-leading-music-streaming-app
[^3]: Отношение DAU/MAU - https://www.thepmrepo.com/articles/how-spotifys-addictive-personalisation-engine-drives-monthly-active-users
[^4]: Кол-во загружаемых песен ежедневно - https://www.musicbusinessworldwide.com/there-are-now-120000-new-tracks-hitting-music-streaming-services-each-day/
[^5]: Кол-во подписок - https://www.musicbusinessworldwide.com/spotify-subscriber-base-grew-by-8m-to-276m-in-q2-company-posted-460m-operating-profit
[^6]: Кол-во треков - https://newsroom.spotify.com/company-info
[^7]: Кол-во пользовательских плейлистов - https://www.musicbusinessworldwide.com/there-are-8bn-user-curated-playlists-on-spotify-725m-created-this-year-alone-daniel-ek-says/
[^8]: Средний размер одной песни - https://www.psafe.com/en/blog/how-much-space-does-music-downloaded-from-spotify-take/#:~:text=Premium%20users%20have%20multiple%20options,a%20lack%20of%20free%20space.
[^9]: Средний размер заголовка запроса - https://www.chromium.org/spdy/spdy-whitepaper/