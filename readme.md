# Spotify

# 1. Тема и целевая аудитория
Spotify - музыкальный стриминговый сервис, позволяющий прослушивать музыкальные композиции, аудиокниги и подкасты.

## MVP 
- регистрация/авторизация;
- добавление понравившейся музыки (поставить лайк песне);
- поиск музыки;
- создание плейлистов;
- возможность лейблам добавлять музыку;
- оформление подписки;
- система рекомендации треков.

## Целевая аудитория
MAU составляет 696M[^1].

- Только 276M пользователей Spotify имеют премиум подписку.
- 44% пользователей - мужчины, 56% - женщины.
- 26% пользователей в диапазон от 18 - 24 лет, 29% в диапазоне 25 - 34, 16% в диапазоне от 35 - 44, 11% в диапазоне от 45 - 54, 19% старше 55 лет[^2].

### Распределение активных пользователей Spotify по регионам[^1]
| Регион | Кол-во пользователей, млн |
|--|--|
| Европа | 194.8 |
| Южная Америка| 190.2|
| Северная Америка | 132.2 |
| Остальной мир | 222.72 |

Категория “Остальной мир” очень динамична благодаря быстрому расширению Spotify на развивающихся рынках, таких как Индия и другие части Азии и Африки.

# 2. Расчет нагрузки

## Продуктовые метрики
- Месячная аудитория 696 млн;
- Дневная аудитория: отношение DAU/MAU = 0.2 => DAU = 0.2 * 696 ≈ 139,2 млн [^3];

### Среднее кол-во действий пользователя по типам в день
| Функционал | Среднее кол-во действий, раз |
|-|-|
| регистрация/авторизация| (MAU2025 - MAU2024) / 365 = (696 млн - 626 млн) / 365 = 192 тыс |
| добавление понравившейся музыки (поставить лайк песне) | DAU * (2 + 0) / 2 = 139 млн |
| поиск музыки | 4 * DAU = 556 млн |
| создание плейлистов | 1,2 млн [^7]|
| возможность лейблам добавлять музыку | 60000 [^1] |
| оформление подписки | 72222 [^5]|

## Технические метрики
### Хранилище
- Регистрация
Здесь основную часть будут занимать аватарки пользователей, средний вес которой равен 2 Мб. За всё время (2006 - 2025): 696 млн пользователей * 2 Мб = 1392 Тб = 1,4 Пб.
За год: 1392 Тб / 19 лет = 73 Тб.
За квартал: 18,25 Тб.

- Возможность лейблам добавлять музыку: всего 100 млн треков, средний размер трека 3 - 10 Мб в зависимости от качества трека => средний размер трека равен 6,5 Мб => размер всей библиотеки песен = 635000 Гб + размер исходника (50 Мб) * 100 млн (т.к. спотифаю необходимо хранить исходники треков) = 635 Тб + 5000 Тб = 5635 Тб.
  

Незначительные по объему:
- Проставление лайка треку: добавляется запись в таблицу, которая хранит id пользователя и id трека => 8 байт + 8 байт = 16 байт.
- Создание плейлистов: необходимо хранить название плейлиста (50 символов), id плейлиста, id пользователя, id треков, которые он хранит, предположим, что средний размер плейлиста равен 30 треков => 50 байт * 2 + 8 байт + 8 байт + 8 байт * 30 = 356 байт.
- Оформление подписки: данные о пользователе и зашифрованные данные о способе оплаты = 30 байт (username) + 120 байт (данные о способе оплаты) = 150 байт.
  
| Действие | Объем памяти за все время | Объем памяти за год | Объем памяти за квартал |
|-|-|-|-|
| Регистрация | 1,4 Пб | 73 Тб | 18 Тб |
| Проставление лайка треку | 15,4 Тб | 812 Гб | 203 Гб |
| Возможность лейблам добавлять музыку | 5635 Тб | 296 Тб | 74 Тб |
| Создание плейлистов | 343 Тб |  18,06 Тб | 4,5 Тб |

### Сетевой трафик
Сводная таблица RPS по типовым действиям, средний и пиковый трафики

| Действие                               | Тип   | RPD           | RPS    | Средний трафик | Пиковый трафик |
|----------------------------------------|-------|---------------|--------|----------------|----------------|
| Регистрация/авторизация        | Запись/чтение  | 192 000       | 2,22   | 35,2 Мбит/с      | 70,4 Мбит/с           |
| Добавление лайка песни                  | Чтение| 139 200 000   | 1 611  | 10 Мбит/с        | 20 Мбит/с       |
| Поиск музыки                            | Запись| 556 800 000   | 6 444  | 45 Гбайт/с      | 90 Гбайт/с      |
| Создание плейлистов                     | Запись| 1 200 000     | 14     | 0,12 Мбит/с      | 0,24 Мбит/с     |
| Возможность лейблам добавлять музыку    | Запись| 60 000        | 0,7    | 700 Мб/с         | 1400 Мб/с        |
| Оформление подписки                     | Запись| 72 222        | 0,836  | 0,006 Мбит/с     | 0,012 Мбит/с     |

Пояснение для таблицы:
- RPD взято из пункта выше Среднее количество действий пользователей по типам в день
- RPS = RPD / 86400. Здесь 86400 = 24 часа * 60 минут * 60 секунд
- Средний трафик = RPS * <Вес данных из пункта выше Хранилище> + <Средний размер заголовка запроса (750 байт)>
- Пиковый трафик = <Средний трафик> * <Коэффициент отношения пикового трафика к среднему = 2


# 3. Глобальная балансировка нагрузки

## Обоснование расположения ДЦ
Известно, что основными пользователями Spotify являются жители Европы. 
Поэтому в Европе датацентры будут находиться во Франкфурте-на-Майне в Германии, в Амстердаме в Нидерландах, в Мадриде в Испании, а также в Стокгольме в Швеции.
В США датацентры будут в Сан-Франциско и Нью-Йорке.
В Южной Америке в Сан-Паулу в Бразилии.
В Африке в ЮАР.
А также в Мумбаи в Индии и в Сингапуре, так как там сейчас наиболее быстро развивается рынок.
| Регион | Страна | Город |
|--------|--------|-------|
|Европа| Германия| Франкфурт-на-Майне|
|Европа| Нидерланды | Амстердам |
|Европа| Испания | Мадрид |
|Европа| Швеция | Стокгольм|
|Северная Америка| США| Сан-Франциско |
|Северная Америка| США| Нью-Йорк |
|Южная Америка| Бразилия | Сан-Паулу |
|Африка| Южная Африка| Йоханнесбург |
|Азия| Индия | Мумбаи |
|Азия| Сингапур| Сингапур |

## Глобальная балансировка
Балансировка нагрузки будет осуществляться следующим образом:
GeoDNS: для определения местоположения клиента на основе его географических данных, что позволяет направить его к наиболее близкому серверному центру в соответствующем регионе.

# 4. Локальная балансировка нагрузки

## L4
В качестве L4 балансировщика будет использоваться Virtual Server via Direct Routing. Этот метод обладает максимальной производительностью, так как ответ от бэкенд-сервера уходит напрямую клиенту, минуя балансировщик. Недостаток данного метода в том, что все серверы должны находитсья в одной физической сети. Это можно обойти с помощью GRE-туннелей.

На каждый датацентр резервируется N+1 балансировщик.


## L7
Запросы будут обрабатываться по алгоритму Least Connections.

Каждый запрос проходит два уровня балансировки.
![image](/img/ssl.svg)

Так как для некоторых запросов высокий RPS, то потребуется кластер серверов для дешифрования данных.

На каждый датацентр резервируется N+1 балансировщик.

## Отказоустойчивость 
Автоматическое переключение на резервные узлы выполняется с помощью keepalived.

## Расчет необходимого числа балансировщиков
L3/L4: 1 устройство = 100 Гбит/с
L7: 1 устройство = 5 000 RPS / 20 Гбит/с (SSL дешифровка)
| Расположение ДЦ        | Регион           | Гбит/с | N (L4) | N (L7) |
| ---------------------- | ---------------- | -----: | -----: | -----: |
| Франкфурт-на-Майне | Европа           |     85 |      2 |      2 |
| Амстердам          | Европа           |     43 |      2 |      2 |
| Мадрид             | Европа           |     43 |      2 |      2 |
| Стокгольм          | Европа           |     43 |      2 |      2 |
| Сан-Франциско      | Северная Америка |    110 |      3 |      2 |
| Нью-Йорк           | Северная Америка |    109 |      3 |      2 |
| Сан-Паулу          | Южная Америка    |     73 |      2 |      2 |
| Йоханнесбург       | Африка           |     22 |      2 |      2 |
| Мумбаи             | Азия             |     73 |      2 |      2 |
| Сингапур           | Азия             |     73 |      2 |      2 |


# 5. Логическая схема БД
![db6](/img/db_6.svg)




## Источники
[^1]: Статистика пользователей Spotify - https://www.demandsage.com/spotify-stats/
[^2]: Статистика пользователей Spotify по возрасту - https://techbehemoths.com/blog/spotify-marketing-strategy-analyzed-leading-music-streaming-app
[^3]: Отношение DAU/MAU - https://www.thepmrepo.com/articles/how-spotifys-addictive-personalisation-engine-drives-monthly-active-users
[^4]: Кол-во загружаемых песен ежедневно - https://www.musicbusinessworldwide.com/there-are-now-120000-new-tracks-hitting-music-streaming-services-each-day/
[^5]: Кол-во подписок - https://www.musicbusinessworldwide.com/spotify-subscriber-base-grew-by-8m-to-276m-in-q2-company-posted-460m-operating-profit
[^6]: Кол-во треков - https://newsroom.spotify.com/company-info
[^7]: Кол-во пользовательских плейлистов - https://www.musicbusinessworldwide.com/there-are-8bn-user-curated-playlists-on-spotify-725m-created-this-year-alone-daniel-ek-says/
[^8]: Средний размер одной песни - https://www.psafe.com/en/blog/how-much-space-does-music-downloaded-from-spotify-take/#:~:text=Premium%20users%20have%20multiple%20options,a%20lack%20of%20free%20space.
[^9]: Средний размер заголовка запроса - https://www.chromium.org/spdy/spdy-whitepaper/